<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irrigação 3.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style>
* {
    outline: 0;

    --bg1: #121212;
    --bg2: #1d1d1d;
    --bg3: #3b3b3b;
    --bg4: #5a5a5a;
    --bg5: #727272;
    --color1: #84a1ff;

    --textDefault: #fff;
    --textLightGray: #969696;
}

input {
    background-color: var(--bg1);
    color: var(--textDefault);
    border-radius: .5rem;
    padding: .2rem .4rem;
    border: none;
}
input[type="time"]::-webkit-calendar-picker-indicator{
  filter: invert(100%) ;
}
.text-light-gray {
    color: var(--textLightGray);
}

body {
    background-color: var(--bg1);
    color: var(--textDefault);
    font-size: 1.2rem;
    /* background-color: #1d1d1d; */
}
.header {
    background-color: var(--bg2);
    padding: 10px 15px;
    color: var(--color1);
    display: flex;
    align-items: center;
    /* background-color: rgb(0, 0, 180); */
}
.header h1 {
    margin: 0;
}
.returnArrow {
    font-size: 2rem;
    font-family: emoji;
    margin-right: 2rem;
    transform: scale(2);
}
.card {
    background-color: var(--bg2);
    padding: 10px 15px;
}
span.chb {
    display: inline-block;
    width: 2rem;
    height: 1rem;
    border-radius: .5rem;
    background-color: var(--bg3);
    padding: 0;
    position: relative;
    top: .3rem;
}
span.chb > span {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border-radius: .5rem;
    background-color: var(--bg5);
    padding: 0;
    margin: 0;
    transition: margin 100ms, background-color 100ms;
}
input.chb {
    display: none;
}
input.chb:checked + label span.chb > span {
    margin-left: 1rem;
    background-color: var(--color1);
}
.lineBetweenRows > .row:not(:first-child) {
    position: relative;
}
.lineBetweenRows > .row:not(:first-child)::before {
    content: "";
    background-color: var(--bg3);
    display: block;
    width: 100%;
    height: 1px;
    margin: 1px 10px;
}
.spacingBetweenRows .row > * {
    /* border: 1px solid #0f0; */
    padding-top: 10px;
    padding-bottom: 10px;
}

.page {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: var(--bg1);
}

.orderContainer > * > *  input {
    width: 4rem;
    /* border: 1px solid #f00; */
}

.timesContainer > * > *  input {
    width: 6rem;
    /* border: 1px solid #f00; */
}
.orderContainer > *,
.timesContainer > * {
    justify-content: center;
}


    </style>
</head>
<body>
    <div class="page pageMain" style="display: none;">
        <div class="container-fluid header">
            <h1>Painel de controle</h1>
        </div>
        <div class="px-2 pb-1">
            <div class="container-md card my-2">
                <h2>Programações automáticas:</h2>
                <p>
                    Status:
                    <input id="pg_main" class="chb" type="checkbox">
                    <label for="pg_main">
                        <span class="chb"><span>&#8203;</span></span>
                        <span id="pg_main_input_text">Oi</span>
                    </label>
                </p>

                <div id="programations" class="container-fluid lineBetweenRows spacingBetweenRows">
                </div>

            </div>
            <div class="container-md card my-2">
                <h2>Ativar setor manualmente:</h2>
                <p class="text-light-gray">É necessário pausar as programações automáticas</p>

                <div class="container-fluid lineBetweenRows spacingBetweenRows">
                    <div class="row">
                        <div class="col">0</div>
                        <div class="col">ligado</div>
                        <div class="col-auto">
                            <input id="sma0_main" class="chb" type="checkbox">
                            <label for="sma0_main">
                                <span class="chb"><span>&#8203;</span></span>
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">1</div>
                        <!-- <div class="col">ligado</div> -->
                        <div class="col-auto">
                            <input id="sma1_main" class="chb" type="checkbox">
                            <label for="sma1_main">
                                <span class="chb"><span>&#8203;</span></span>
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">2</div>
                        <!-- <div class="col">ligado</div> -->
                        <div class="col-auto">
                            <input id="sma2_main" class="chb" type="checkbox">
                            <label for="sma2_main">
                                <span class="chb"><span>&#8203;</span></span>
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">3</div>
                        <!-- <div class="col">ligado</div> -->
                        <div class="col-auto">
                            <input id="sma3_main" class="chb" type="checkbox">
                            <label for="sma3_main">
                                <span class="chb"><span>&#8203;</span></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- programations page -->

    <div class="page pageProgramation" style="display: none;">
        <div class="container-fluid header">
            <span class="returnToMain returnArrow">&#9666;</span><h1>Programação <span>x</span></h1>
            <!--◀-->
        </div>
        <div class="px-2 pb-1">
            <div class="container-md card my-2">
                <h2>Ativação automática:</h2>
                <p>
                    Status:
                    <input id="paax_prog" class="chb" type="checkbox">
                    <label for="paax_prog">
                        <span class="chb"><span>&#8203;</span></span>
                    </label>
                </p>
            </div>
            <div class="container-md card my-2">
                <h2>Ordem de ativação:</h2>
                <div class="container-fluid orderContainer">
                    <div class="row">
                        <div class="col-auto my-1">
                            1º: <input type="number" placeholder="Vazio">
                        </div>
                        <div class="col-auto my-1">
                            2º: <input type="number" placeholder="Vazio">
                        </div>
                        <div class="col-auto my-1">
                            3º: <input type="number" placeholder="Vazio">
                        </div>
                        <div class="col-auto my-1">
                            4º: <input type="number" placeholder="Vazio">
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-md card my-2">
                <h2>Horários de ativação:</h2>
                <div class="container-fluid timesContainer">
                    <div class="row">
                        <div class="col-auto my-1">
                            <input type="time">
                        </div>
                        <div class="col-auto my-1">
                            <input type="time">
                        </div>
                        <div class="col-auto my-1">
                            <input type="time">
                        </div>
                        <div class="col-auto my-1">
                            <input type="time">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>
const espURL = ".";
$(document).ready(()=>{
    
    $("#pg_main").change(handle_pg_main_change);
    $(".returnToMain").click(loadMainPage);

    getInfo(()=>{
        console.log("informacoes carregadas");
        getProgramations(()=>{
            console.log("programacoes carregadas");
            loadMainPage();
        });
    });
});

var info = {
    numOfStages: null,
    numOfTriggers: null,
    numOfProgramations: null,
    numOfSections: null,
    programationEmpty: null,
    sectionEmpty: null,
    maxDuration: null,
    areProgramationsPaused: null,
    manuallyActivatedSector: null,
}
function getInfo(functionToRunAfterFinishing)
{
    runCommand({
        cmd: "mostrarInformacoes",
        success: (data)=>{
            splitInLines(data).forEach(line=>{
                var doubp = line.indexOf(":");
                var val = parseInt(line.substr(doubp+1));
                switch(line.substr(0, doubp))
                {
                    case "numOfStages":
                        info.numOfStages = val;
                        break;
                    case "numOfTriggers":
                        info.numOfTriggers = val;
                        break;
                    case "numOfProgramations":
                        info.numOfProgramations = val;
                        break;
                    case "numOfSections":
                        info.numOfSections = val;
                        break;
                    case "programationEmpty":
                        info.programationEmpty = val;
                        break;
                    case "sectionEmpty":
                        info.sectionEmpty = val;
                        break;
                    case "maxDuration":
                        info.maxDuration = val;
                        break;
                    case "areProgramationsPaused":
                        info.areProgramationsPaused = Boolean(val);
                        break;
                    case "manuallyActivatedSector":
                        info.manuallyActivatedSector = val;
                        break;
                    default:
                        error(1);
                        return;
                }
            });

            var gotError = false;
            Object.getOwnPropertyNames(info).forEach(propName=>{
                if(info[propName] === null && !gotError) gotError = true;
            });

            if(gotError)
            {
                error(1);
                return;
            }
            else if(typeof functionToRunAfterFinishing == "function") functionToRunAfterFinishing();
        }
    });
}

var programations = [];
function getProgramations(functionToRunAfterFinishing)
{
    runCommand({
        cmd: "mostrarProgramacoes",
        success: (data)=>{
            var lines = splitInLines(data);

            var gotError = false;

            lines.forEach((line, i) => {
                if(gotError) return;

                arrow = line.indexOf("→");
                dash = line.indexOf("-");

                var prog = {
                    enabled: null,
                    orders:[],
                    durations:[],
                    triggers: []
                }

                if(arrow == -1 || dash == -1)
                {
                    error(2);
                    gotError = true;
                    return;
                }

                if(i != parseInt(line.substr(0, arrow)))
                {
                    error(2);
                    gotError = true;
                    return;
                }



                var ordersDurations = line.substr(arrow+1, dash-arrow-1);
                switch(ordersDurations.substr(0, 1))
                {
                    case "L":
                    case "l":
                        prog.enabled = true;
                        break;
                    case "D":
                    case "d":
                        prog.enabled = false;
                        break;
                    default:
                        error(2);
                        gotError = true;
                        return;
                }

                if(ordersDurations.substr(-1) != "}") {error(2); gotError=true;return;}
                ordersDurations = ordersDurations.substr(1, ordersDurations.length-2).replaceAll("{", "");

                ordersDurations.split("}").forEach((orderDuration, i)=>{
                    var virg = orderDuration.indexOf(",");
                    prog.orders[i] = parseInt(orderDuration.substr(0, virg));
                    prog.durations[i] = parseInt(orderDuration.substr(virg+1));
                });

                var triggers = line.substr(dash+1).replaceAll("{", "");
                if(triggers.substr(-1) != "}") {error(2); gotError=true;return;}
                triggers = triggers.substr(0, triggers.length-1);

                triggers.split("}").forEach((trigger, i)=>{
                    prog.triggers[i] = trigger.substr();
                });

                programations[i] = prog;
            });

            if(!gotError && typeof functionToRunAfterFinishing == "function") functionToRunAfterFinishing();
        }
    });
}

function splitInLines(str)
{
    return str.replaceAll("\r\n", "\n").replaceAll(" ", "").split("\n");
}

function error(str)
{
    if(typeof str == "number")
    {
        switch(str)
        {
            case 1:
                str = `Falha ao tentar decodificar "mostrarInformacoes"`
                break;
            case 2:
                str = `Falha ao tentar decodificar "mostrarProgramacoes"`
                break;
            case 3:
                str = `Falha ao tentar executar o comando`
                break;
        }
    }
    alert(str);
    console.log(str);
}



function runCommand(obj)
{
    if(typeof obj.before == "function") obj.before();

    var args = "";
    var cmd = "";
    var spcIdx = obj.cmd.indexOf(" ");
    if(spcIdx == -1) cmd = obj.cmd;
    else
    {
        args = obj.cmd.substr(spcIdx+1);
        cmd = obj.cmd.substr(0, spcIdx);
    }

    $.ajax({
        url: `${espURL}/${cmd}.txt`,
        success: (data)=>{
            if(typeof obj.success == "function") obj.success(data);
        },
        error: ()=>{
            error(3);
            if(typeof obj.error == "function") obj.error();
        },
        complete: ()=>{
            if(typeof obj.complete == "function") obj.complete();
        }
    });

}




function loadPage(pageClass)
{
    $(`.page:not(.${pageClass})`).hide();
    $(`.page.${pageClass}`).show();
}

function loadMainPage()
{
    $("#programations").html("");
    programations.forEach((programation, i)=>{
        $("#programations").append(`
            <div class="row" id="p${i}_main" onclick="loadProgramationPage(${i})">
                <div class="col-1">${i}</div>
                <div class="col pstt ${info.areProgramationsPaused?"text-light-gray":(programation.enabled?"text-success":"text-danger")}">${programation.enabled?"ligado":"desligado"}</div>
                <div class="col-auto">setores: </div>
                <div class="col">${orderStr(programation.orders)}</div>
            </div>
        `);
    });
    $("#pg_main")[0].checked = !info.areProgramationsPaused;
    loadPage("pageMain");
}

function orderStr(orders)
{
    var str = "";
    orders.forEach((order, i)=>{
        if(order != info.sectionEmpty)
        {
            if(i != 0) str += " ";
            str += order;
        }
    });
    return str;
}

function loadProgramationPage(progNum)
{
    loadPage("pageProgramation");
}

var inputStates = {
    "pg_main": {
        state: null,
        transition: false,
    }
};

function setInputState(input, state)
{
    inputStates[input].state = state;
    updtInput(input);
}
function setInputTransition(input, trst)
{
    inputStates[input].transition = trst;
    updtInput(input);
}
function getInputState(input)
{
    return inputStates[input].state;
}
function getInputTransition(input)
{
    return inputStates[input].transition;
}
function updtInput(input)
{
    $("#"+input)[0].checked = inputStates[input].state;

    var txt = $(`#${input}_input_text`);

    if(inputStates[input].state) txt.addClass("text-success").removeClass("text-danger");
    else txt.addClass("text-danger").removeClass("text-success");

    if(inputStates[input].transition)
    {
        txt.css("opacity", "0.5");
        if(inputStates[input].state) txt.text("Ligando...");
        else txt.text("Desligando...");
    }
    else
    {
        txt.css("opacity", "1");
        if(inputStates[input].state) txt.text("Ligado");
        else txt.text("Desligado");
    }
}

function updateProgramationsStt()
{
    var stts = $("#programations > * .pstt");
    if(getInputState("pg_main"))
    {   
        stts.removeClass("text-light-gray");
        stts.each(function(i){
            $(this).addClass(programations[i].enabled?"text-success":"text-danger");
        });
    }
    else stts.removeClass("text-success").removeClass("text-danger").addClass("text-light-gray")
}

function handle_pg_main_change(e)
{
    if(getInputTransition("pg_main"))
    {
        $("#pg_main")[0].checked = !$("#pg_main")[0].checked;
        return;
    };

    runCommand({
        cmd: $("#pg_main")[0].checked?"retomarProgramacoes":"pausarProgramacoes",
        before: ()=>{
            setInputState("pg_main", $("#pg_main")[0].checked);
            setInputTransition("pg_main", true);
            updateProgramationsStt();
        },
        success: data=>{
        },
        error: data=>{
            setInputState("pg_main", !getInputState("pg_main"));
            updateProgramationsStt();
        },
        complete: data=>{
            setInputTransition("pg_main", false);
        }
    });
}

    </script>
</body>
</html>